on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
    - '[0-9]*' # Push events to matching *, i.e. 1.0, 20.15.10

name: Create Release and Upload Assets

jobs:
  build_mac:
    name: Mac Release
    runs-on: macOS-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v1
        with:
          go-version: '1.15'
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Build
        env:
          DOCKER_TOKEN: ${{secrets.DOCKER_TOKEN}}
          DOCKER_USER: ${{secrets.DOCKER_USER}} 
        run: |
          make release_mac

      - name: Create Artifacts File
        id: mac_artifact
        run: |
          sudo ln -s iogw/setup/mac/target/pkg/*.pkg iogw.pkg
          MACPATH=$(ls iogw/setup/mac/target/pkg/*.pkg)
          MACNAME=$(basename iogw/setup/mac/target/pkg/*.pkg)
          MACBUILD=iogw/setup/mac/application/bin
          MACEXE=iogw_mac
          echo MACPATH=${MACPATH} > mac_variables.sh
          echo MACNAME=${MACNAME} >> mac_variables.sh
          echo MACBUILD=${MACBUILD} >> mac_variables.sh
          echo MACEXE=${MACEXE} >> mac_variables.sh

      - name: Upload Release pkg file as Artifact
        uses: actions/upload-artifact@v1
        with:
          name: mac_artifact
          path: iogw.pkg

      - name: Upload Release mac variables as Artifact
        uses: actions/upload-artifact@v1
        with:
          name: variables
          path: mac_variables.sh

  build:
    name: Windows and Linux Release
    runs-on: ubuntu-latest
    needs: build_mac
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Build
        id: build
        env:
          DOCKER_TOKEN: ${{secrets.DOCKER_TOKEN}}
          DOCKER_USER: ${{secrets.DOCKER_USER}}
        run: |
          bash setup.sh "$DOCKER_USER" "$DOCKER_TOKEN"
          source source-me-first
          sudo apt-get install -y alien
          make release
          DEBPATH=$(ls iogw/setup/linux/deb/iogw_*.deb)
          DEBNAME=$(basename iogw/setup/linux/deb/iogw_*.deb)
          RPMPATH=$(ls iogw/setup/linux/rpm/iogw-*.rpm)
          RPMNAME=$(basename iogw/setup/linux/rpm/iogw-*.rpm)
          WINPATH=$(ls iogw/setup/windows/iogw-*.exe)
          WINNAME=$(basename iogw/setup/windows/iogw-*.exe)
          echo ::set-output name=deb_path::${DEBPATH}
          echo ::set-output name=deb_name::${DEBNAME}
          echo ::set-output name=rpm_path::${RPMPATH}
          echo ::set-output name=rpm_name::${RPMNAME}
          echo ::set-output name=win_path::${WINPATH}
          echo ::set-output name=win_name::${WINNAME}
          echo ::set-output name=lin_build::iogw/setup/linux/bin
          echo ::set-output name=lin_exe::iogw_linux
          echo ::set-output name=win_build::iogw/setup/windows
          echo ::set-output name=win_exe::iogw.exe

      - name: Download mac pkg Artifact
        uses: actions/download-artifact@v1
        with:
          name: mac_artifact

      - name: Download mac variables Artifact
        uses: actions/download-artifact@v1
        with:
          name: variables

      - name: Set mac variables
        id: mac_variables
        run: |
          source variables/mac_variables.sh
          echo ::set-output name=mac_path::${MACPATH}
          echo ::set-output name=mac_name::${MACNAME}
          echo ::set-output name=mac_build::${MACBUILD}
          echo ::set-output name=mac_exe::${MACEXE}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload .deb
        id: upload-release-deb-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.deb_path }}
          asset_name: ${{ steps.build.outputs.deb_name }}
          asset_content_type: application/x-debian-package

      - name: Upload .rpm
        id: upload-release-rpm-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.rpm_path }}
          asset_name: ${{ steps.build.outputs.rpm_name }}
          asset_content_type: application/x-redhat-package-manager

      - name: Upload .exe
        id: upload-release-win-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.win_path }}
          asset_name: ${{ steps.build.outputs.win_name }}
          asset_content_type: application/octet-stream

      - name: Upload .pkg
        id: upload-release-mac-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: mac_artifact/iogw.pkg
          asset_name: ${{ steps.mac_variables.outputs.mac_name }}
          asset_content_type: application/x-newton-compatible-pkg

      - name: Upload linux
        id: upload-release-linux-exe
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.lin_build }}
          asset_name: ${{ steps.build.outputs.lin_exe }}
          asset_content_type: application/octet-stream


      - name: Upload windows
        id: upload-release-windows-exe
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.win_build }}
          asset_name: ${{ steps.build.outputs.win_exe }}
          asset_content_type: application/octet-stream

      - name: Upload mac
        id: upload-release-mac-exe
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ${{ steps.build.outputs.mac_build }}
          asset_name: ${{ steps.build.outputs.mac_exe }}
          asset_content_type: application/octet-stream
